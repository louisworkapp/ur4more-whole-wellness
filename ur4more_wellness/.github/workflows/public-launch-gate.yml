name: Public Launch Gate

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
      - develop
  workflow_dispatch:

jobs:
  safety-check:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          $gitleaksVersion = "v8.18.0"
          $gitleaksUrl = "https://github.com/gitleaks/gitleaks/releases/download/$gitleaksVersion/gitleaks_8.18.0_windows_x64.zip"
          $gitleaksZip = "$env:RUNNER_TEMP\gitleaks.zip"
          $gitleaksDir = "$env:RUNNER_TEMP\gitleaks"
          Invoke-WebRequest -Uri $gitleaksUrl -OutFile $gitleaksZip
          Expand-Archive -Path $gitleaksZip -DestinationPath $gitleaksDir -Force
          $gitleaksExe = "$gitleaksDir\gitleaks.exe"
          echo "$gitleaksDir" >> $env:GITHUB_PATH

      - name: Install trufflehog
        run: |
          $trufflehogVersion = "v3.63.1"
          $trufflehogUrl = "https://github.com/trufflesecurity/trufflehog/releases/download/$trufflehogVersion/trufflehog_3.63.1_windows_amd64.zip"
          $trufflehogZip = "$env:RUNNER_TEMP\trufflehog.zip"
          $trufflehogDir = "$env:RUNNER_TEMP\trufflehog"
          Invoke-WebRequest -Uri $trufflehogUrl -OutFile $trufflehogZip
          Expand-Archive -Path $trufflehogZip -DestinationPath $trufflehogDir -Force
          $trufflehogExe = "$trufflehogDir\trufflehog.exe"
          echo "$trufflehogDir" >> $env:GITHUB_PATH

      - name: Run public safety check
        run: |
          powershell -NoProfile -ExecutionPolicy Bypass -File tools\public_safety_check.ps1 -Strict -CI
